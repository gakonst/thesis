\chapter{Metering and Billing of Energy on Ethereum}\label{ch:implementation}

Smart contracts can be transformative for the energy industry. In this chapter we explore the inefficiencies of the energy market and identify gaps which can be filled by blockchain. We go through the advantages of an energy-based application  built on smart contracts. Finally, we describe the business logic of a specific energy use-case which we implemented on Ethereum. The implementation takes into account the methods and concepts described in Chapter \ref{ch:scalability} and Chapter \ref{ch:security} in order to ensure that the smart contracts are efficient and robust.

\section{Energy Market inefficiencies}

The global energy market is gradually transitioning to clean and renewable energy. Regulations encourage usage of distributed energy resources (DERs). The grid is becoming digitalized and the expectations and behaviors of the consumers are changing. With the integration of DERs, consumers transform into prosumers who store their energy surplus or sell it to their peers, effectively distributing the generation of energy, contrary to existing power systems which were designed to accomodate central points of energy generation.

There are numerous inefficiencies which need to be resolved in today's energy markets \cite{ey-inefficiencies}:
\begin{enumerate}
    \item \textbf{Transaction complexity:} More participants in the networks result in more complex transactions.
    \item \textbf{Predictability and Reliability:} Availability of DERs is less predictable compared to traditional energy resources like coal. 
    \item \textbf{Empowered prosumer:} There need be monitoring tools and infrastructure to allow prosumers to have flexibility in their energy distribution.
    \item \textbf{Geographic mismatches:} Locations that fully utilize DERs are usually far from key points of energy demand. Transmitting energy over long distances is inefficient.
    \item \textbf{Trust and Security:} New participants will only choose the system if it is able to be trusted and is properly secured.
\end{enumerate}


%Today's energy markets are called to resolve a number of issues.
% Having discussed how Ethereum works, and explained techniques to improve smart contracts' scalability and security, we proceed to discuss the topic of making energy markets more transparent and efficient by utilizing smart contracts. The use-case we describe can be used as a starting point for better tracking of energy usage inside a company, allowing better prediction of future needs.  
% The world is gradually shifting from nuclear and fossil fuels to Renewable Energy Sources (RES). RES have been taking a larger share of Germany's gross energy production and this has created a 
% Germany is on a rollout plan of installing smart meters in every household which incorporates RES.  
% The barrier to entry to become an energy producer\footnote{By installing solar panels for example} 
% Chart for renewables: https://www.cleanenergywire.org/factsheets/germanys-energy-consumption-and-power-mix-charts
% In its current state, most consumers do not know what they are paying Business level take long time and are 

% Price of energy, consumer does not know always what they pay, or what they gain from their renewables
 
\section{Energy Market use-cases for Blockchain}

A number of use-cases for smart contracts have been identified in the energy market. We proceed to describe applications that derive from the advantages of blockchain (transparency, trustlessness, efficiency, security) as discussed in Section \ref{advantages}.

\begin{enumerate}
    \item \textbf{Supply chain tracking and optimization:} This is a broad blockchain use case which allows for optimization on logistics and tracking the location of products, reducing fraud and ensuring the validity of an event.
    \item \textbf{Energy metering and billing:} By committing the values of energy consumed by entities to a blockchain, a timestamped record of meter readings gets generated which allows for the verification and more clear understanding of energy consumption across resources. This can be augmented to provide billing functionality (further described in \ref{business-logic}).
    \item \textbf{Peer to Peer (P2P) energy trading:} Consumers and prosumers operate in a local microgrid and trade energy between them, without a centralized operator, resulting in reduced loss of energy during transportation.
    \item \textbf{Electric vehicles charging:} This is an extension of P2P energy trading, allowing a car that is far from its charging station to be charged by the surplus energy of another car. It can also contribute to peak shaving~\footnote{Energy is billed based on the peak energy consumed during a time window. By consuming energy for charging during low peak times the peak can be reduced.} effectively reducing the costs during that time window.
\end{enumerate}

% By using smart contracts, all of the above use-cases can be automated
% Use Cases:
% - P2P Energy Trading
% - Sharing Economy - EV share and charge

% Internet of Things sensors can securely streamline inspections and repairs and automatically reduce outages.
% Applications have been developed \cite{DBLP:journals/ife/MengelkampNBDW18}

% Blockchains have the ability to provide transparency and immutability. Also,  When talking about energy and transparency, full history of meter readings, price calculation, billing of inhouse energy departments. This can be extended for EV car payment microtransactions and so on.

% The blockchain is a particularly interesting technology for decentralized processes that require large networks and trust relationships between all parties. Therefore, it offers great benefits to the power & utilities market, with its large networks of power and utilities companies, (maintenance) subtractors, (local) suppliers and end users.

% Smart meters Still, there are other applications that are ready for use in the near future. Smart meters for instance have already entered many homes. Up until now, sharing data through smart meters was a threat to the privacy of the owner of the meter. Again, the blockchain offers a potential solution. It can provide the accurate data to the supplier without requiring a direct link to the meter of specific users. When needed, the owner of the smart meter can prove to the supplier that the data are his, using his private key, and the cryptographic security of the blockchain proves that the information is accurate and hasnâ€™t been tampered with. This puts the owner in control of his own data.

\section{Business Logic} \label{business-logic}
In collaboration with Honda R\&D Germany, we create a pilot suite of smart contracts for in-house use in order to track and bill the consumed energy of the company's headquarters as measured by a set of smart meters. 

Describe meters, billing and so ona
The purpose is to serve as a means of tracking the energy consumed by the company's smart meters and ensuring the data's validity and existence in a smart contract. In addition, due to the complex structure of the company, every smart meter's consumption can contribute with different coefficients to the total energy consumption of the rooms in a building. As a result, the developed smart contract are able to track the energy consumption of each room and assign it to a higher-order 
We proceed to discuss the business logic of the use-case and then implement it. We utilize the technique from \ref{method3} to optimize our smart contracts for gas efficiency and utilize Slither from \ref{slither} and the learned best-practices to ensure that the developed smart contracts are robust. Due to the intellectual property of Honda R\&D, all testing and verification of the contracts' functionality was done in a private in-house testnet.

% INSERT GRAPH OF PULLING DATA FROM MONITORING SERVER TO CLIENT, CLIENT SIMULATES THE METERS AND SENDS THE DATA SIGNED WITH THEIR PRIVATE KEYS. TRANSACTIONS GET EXECUTED IN A 3-NODE POA BLOCKCHAIN. EXPLAIN DOCKER HERE. 

\subsection{Metering in Smart Meters and Virtual Meters}

A smart meter must be able to keep track of the current reading and timestamp of the reading as well as the last reading and timestamp in order to calculate the difference of the two. It also has a unique identifier which is used to retrieve it in the smart contract.

Smart meters get grouped in \textit{Virtual Meters}. The consumption of each \textit{Virtual Meter} is equal to a function of the Each smart meter contributes to a room's consumption with a real coefficient, according to Equation \ref{roomcost}
\begin{equation}\label{roomcost}
R = CM + U,
\end{equation}
\noindent where
\begin{description}
\item  \[C = 
\begin{bmatrix}
    c_{11} & \cdots & c_{1M} \\
    \vdots & \ddots & \vdots \\ 
    \vdots & \ddots & \vdots \\
    c_{N1} & \cdots & c_{NM}
  \end{bmatrix},\]
\noindent $c_{ij}$ is the coefficient of the $jth$ meter for the $ith$ room
\item  \[M = 
\begin{bmatrix}
    m_{1} & \cdots & m_{M}
\end{bmatrix}^T,\]
\noindent $m_{i}$ is the kilowatthour reading of the $ith$ meter
\item  \[U=
\begin{bmatrix}
    u_{1} & \cdots & u_{M}
\end{bmatrix}^T,\]
\noindent $u_{i}$ is a constant
\end{description}

The coefficients along with the constants are calculated through Honda R\&D's and are considered known. 

\subsection{Cost Centers, Departments and Business Units}
Virtual Meters are grouped into \textit{Cost Centers}, where the consumption of each \textit{Cost Center} is the sum of the consumptions of its included Virtual Meters.

FURTHER EXPLAIN DEPARTMENTS - FORWARDING LOGIC.

\section{Smart Contracts} \label{ch:implementation:sc}
In this section we go over the implementation and the rationale of each developed smart contract. We explain the inner workings and provide tests of their functionality. A thorough explanation how they interact with each other can be found in \ref{scresults}.

INSERT GRAPH SHOWING:

EACH METER PULLING FROM MONITORING SERVER, PUSHING TO BLOCKCHAIN

EACH VIRTUAL METER PULLING FROM BLOCKCHAIN, PERFORMING OPERATIONS THEN PUSHING TO BLOCKCHAIN Again

EACH COST CENTER PULLING DATA

EACH DEPARTMENT/CC FUNDING THE BUSINESS UNIT BY FORWARDING.

\subsection{Access Control}
Defining a proper access control policy is very important as discussed in Section \ref{ch:security}. It is common to find Access Control Lists (ACL) in enterprise environments which allow access to resources only to selected participants. This does not exist by default in smart contracts. The Aragon Project\footnote{Project aimed at creating DAOs} provides an ACL contract, however it was not used in the final version due to the complexity it introduced to our code\footnote{Aragon's contracts are architected towards creating fully upgradable DAOs, which would introduce considerable overheads and complexity to our code}. Instead, the DSAUTH pattern is used.

\subsection{Contract Registry}
Upgradable logic, call smart contract by name, versioning

\subsection{MeterDB}
MeterDB utilizes \ref{method3} to create a smart contract that keeps track of the last two consumed values and logged timestamps of a smart meter or a virtual meter. A meter must be approved by an entity who has been given access to the \texttt{activateMeter} through the ACL. 

EXPLAIN ASSUMPTIONS FOR DESIGN, NON ITERABLE BUT ITS OK. 

Each meter has its own ID. We use the pattern. Deleting a meter sets the active status to false. We iterate over the array of meters. There are software engineering patterns \cite{crud} that allow more proper usage, however they cost a lot more gas. 


\subsection{Cost - Profit Management}
We follow the same pattern as with meters for storing cost centers. We define 

\section{Client Side}

We utilize Python to interact with the smart contracts and push data to them. We implement multiple command line interfaces which can be used for abstracting the complexity to an operator. Due to design, it can be dockerized and run on multiple blabla.

\subsection{Monitoring Server and REST API}
Due to having dumb meters, we cannot get dirctly. There is a monitoring server which has all the data. A rest api allows us to pull data on demand. API explanation in appendix.k

Could be implemented without monitoring server if each meter was smarter. 
Explain monitoring server.

\subsection{web3.py interaction}
Explain how web3.py interacts with monitoring server and sends data to Smart Contracts

\subsection{Python Bindings and Clients for all functionalities}
Explain python implementation

using pool to launch multiple meter instances.



