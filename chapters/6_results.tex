\chapter{Evaluation of Implementation and Results}\label{ch:results}

We have described an ecosystem of smart contracts that combined with their corresponding client scripts can perform metering and billing of energy on complex business logic. The energy billing per department is done in kilowatthours because there was no specified method of calculating the cost in fiat currency. Converting the measured energy to a fiat currency during the billing process is done outside of the proposed system, without loss of generality. We proceed to evaluate the performance of the implementation of Chapter \ref{ch:implementation}, and explain how the findings from Chapter \ref{ch:scalability} and Chapter \ref{ch:security} are applied to enable better scalability and robustness in the contract design.

\section{Scalability}
On scalability, we applied Method 3 (\ref{method3}) and followed the rules from Section \ref{gas-costs} to save gas. More specifically:

\begin{enumerate}
    \item The optimizer was run 200 times, which was the default option for the Truffle Framework.
    \item Using libraries via Method 3 for storing meter readings and department values resulted in significant code reuse, and reduction of gas costs. Table \ref{table:compare-gas} illustrates the gas savings that the proposed method provides, for each function of the contracts\footnote{The ACL logic was removed for these calculations.}.
    \item Any meter, department that is no longer used can be deactivated, freeing up storage in the smart contract.
    \item Any iterations over arrays are initializing the break condition outside of the loop, reducing the number of \texttt{SLOAD} operations done and thus saving gas.
    \item In all cases, \texttt{string} is avoided and \texttt{bytes32} is used. If a representation was needed that was larger than 32 bytes would be needed, it would be rendered in the front end by matching the 32 bytes to a potential string. 
    \item The minimal amount of data needed is stored in the smart contract. The latest reading and timestamp values are needed for each meter and department, and each department additionally requires storing its hierarchical relationship with other departments, virtual meters and its delegates. The formula for each virtual meter (\ref{metering}) is stored locally because it would significantly increase gas costs to store an arbitrarily long \texttt{string} variable in the smart contract.
    \item Events are emitted for each action providing an inexpensive way to store the historical data of a meter or department. Emitting an event requires 2000 gas, compared to the 20000 gas needed for storing a value. The disadvantage is that event data cannot be accessed by another smart contract which is acceptable in this case as historical data is only meant to be accessed by a client and not a smart contract directly. 
\end{enumerate}

\input{tables/comparison-struct.tex}

\section{Security}

Having studied and understood past literature as well as attacks on smart contracts, the implementation is developed so that none of the known attacks can be reproduced. In Section \ref{slither} we evaluated that Slither can detect a wide variety of vulnerabilities, and can outperform at most cases the other available security auditing tools. Auditing our smart contracts through Slither showed no true positives, which given the past performance of the tool, gives us a high degree of confidence with regard to the robustness of the developed smart contracts against known attacks.

We utilized and applied an access control list to the implemented smart contracts which is able to enforce role based access control. Roles are given only access to specific functions of a smart contract that they must have access to, following the security principle of least privilege. Each user is then granted a role, which provides a modular method to revoke and modify the rules, in case of changes in the structure of an organization. Providing a way to enforce access control is important because smart contract ecosystems will become more complex as the requirements increase. More actors will need to be involved, and there will be a need to limit the functionality of each actor. In addition, it is not efficient to modify the permissions of each actor on a per-contract basis, and as a result a central directory of permissions needs to exist. In the past, as described in Section \ref{past-attacks}, lack of proper access control cost large amounts of funds to the involved parties.

\section{Complete overview}
The final implementation was tested with a setup of 48 smart meters, 44 virtual meters and 20 departments. The simulation was conducted on a Dell Laptop and consumed less than 10\% of the laptop's CPU and RAM resources, which illustrates how lightweight it is. The deployment of the smart contracts was firstly tested on a local ganache testnet instance, then on a locally deployed testnet of 2 geth instances, where 1 was acting as a node and another as a miner, and finally on the Ropsten public testnet. Due to company requirements, there was no deployment to a public network, however the contract design allows that. 

The operating costs are correlated linearly to the frequency that the data is pushed to the smart contracts. 

\begin{enumerate}
    \item \textbf{Meters:} The monitoring server is updated every 12 minutes, however since the change in values is very small, we poll the monitoring server and update the values of the smart meters every 2 hours\footnote{The selected frequency was a company requirement. Further granularity provided no advantage. It is possible to push values every 12 minutes, at a linear increase in cost}. As a result, the operating cost for pinging the values of 48 meters for a year\footnote{The chosen gas price is $1 GWei = 10^{-9} ether$ since the operations are not time critical. When there is a need for fast confirmations the price is expected to be higher.} is: 48 meters * 31422 gas * 0.5 readings / hour * 24 hours * 365 days * 1 Gwei/gas  = 6.6 ether, which reduces to each meter needing 0.1375 ether in order to be able to interact with the smart contract at the specified frequency for a year. 
    \item \textbf{Virtual Meters:} Pushing the values of Virtual Meters is required to be done twice every month and so the total cost of running 44 virtual meters is: 44 virtual meters * 31422 gas * 2 readings / month * 12 months * 1 Gwei/gas  = 0.03 ether, which reduces to each virtual meter needing 0.0007 ether to interact with the smart contract at the specified frequency for a year. 
    \item \textbf{Billing:} Calculating the consumption of each business unit and performing cost forwarding for internal accounting is required to be done once every month. It was simulated that a full billing cycle of pulling values from virtual meters, updating each department's consumption and delegating it according to the business logic costs X ether per month, or X ether per year. 
\end{enumerate}
